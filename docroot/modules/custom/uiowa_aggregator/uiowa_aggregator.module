<?php

/**
 * @file
 * Primary module hooks for uiowa_aggregator module.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;
use Drupal\media\Entity\Media;
use Drupal\uiowa_core\Element\Card;
use Drupal\uiowa_core\HeadlineHelper;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function uiowa_aggregator_form_aggregator_admin_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Remove never from aggregator cleanup options. Keeping items forever has
  // potential to create very large database tables. Add additional options.
  unset($form['processors']['aggregator']['aggregator_clear']['#options'][0]);
  $form['processors']['aggregator']['aggregator_clear']['#options'][15552000] = t('6 months');
  $form['processors']['aggregator']['aggregator_clear']['#options'][31557600] = t('1 year');

  // Remove access to aggregator teaser length as it does nothing!
  // @see: https://www.drupal.org/project/drupal/issues/2283877
  $form['processors']['aggregator']['aggregator_teaser_length']['#access'] = FALSE;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function uiowa_aggregator_form_aggregator_feed_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  /** @var Drupal\uiowa_core\Access\UiowaCoreAccess $check */
  $check = \Drupal::service('uiowa_core.access_checker');

  /** @var Drupal\Core\Access\AccessResultInterface $access */
  $access = $check->access(\Drupal::currentUser()->getAccount());

  // Set the minimum feed refresh to match our hourly cron job so that
  // webmasters aren't confused as to why it's not refreshing sooner. Admins can
  // set this to whatever assuming they set up a custom job to run more often.
  if ($access->isForbidden()) {
    foreach ($form['refresh']['widget']['#options'] as $key => $value) {
      if ($key !== 0 && $key < 3600) {
        unset($form['refresh']['widget']['#options'][$key]);
      }
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_build_defaults_alter().
 */
function uiowa_aggregator_aggregator_item_build_defaults_alter(array &$build, EntityInterface $entity, $view_mode) {
  $build['#type'] = 'card';
  unset($build['#theme']);
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function uiowa_aggregator_aggregator_item_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  $build['#meta']['author'] = $build['author'];
  $build['#content'] = $build['description'];
  $build['#subtitle']['timestamp'] = \Drupal::service('date.formatter')->format((int) $build['timestamp']);

  unset($build['author']);
  unset($build['description']);
  unset($build['timestamp']);

  // Only add the feed image  and heading size to the aggregator item if we're
  // not on the canonical feed page.
  if (\Drupal::routeMatch()->getRouteName() !== 'entity.aggregator_feed.canonical') {
    // Set the heading level size for use in the template.
    $build['#title_heading_size'] = $variables['elements']['#heading_size'] ?? 'h3';

    /** @var Drupal\aggregator\Entity\Feed $feed */
    $feed = \Drupal::entityTypeManager()
      ->getStorage('aggregator_feed')
      ->load($entity->getFeedId());
    $mid = $feed->field_aggregator_feed_image
      ?->target_id;

    // Establish default view mode if layout_builder_styles don't exist.
    $image_view_mode = 'large__square';

    // Map the layout builder styles to the view mode that should be used.
    $media_formats = [
      'media--widescreen' => 'large__widescreen',
      'media--square' => 'large__square',
      'media--circle' => 'large__square',
    ];

    // Set the view mode based on the media format.
    if (isset($build['#override_styles']['media_format']) && isset($media_formats[$build['#override_styles']['media_format']])) {
      $image_view_mode = $media_formats[$build['#override_styles']['media_format']];
    }

    // A local feed image should take precedence.
    if (!is_null($media = Media::load($mid))) {
      $feed_image = \Drupal::entityTypeManager()->getViewBuilder('media')->view($media, $image_view_mode);
      if (!in_array($image_view_mode, $feed_image['#cache']['keys'])) {
        unset($feed_image['#cache']['keys']);
      }
      $build['#media']['field_aggregator_feed_image'] = $feed_image;
    }
    elseif ($image = $feed->getImage()) {
      $build['#meta']['feed_image_external'] = [
        '#theme' => 'imagecache_external_responsive',
        '#uri' => $image,
        '#responsive_image_style_id' => $image_view_mode,
        '#attributes' => [
          'data-lazy' => TRUE,
          'alt' => t('@title feed image', ['@title' => $feed->get('title')->getString()]),
          'class' => [
            'feed-image',
          ],
        ],
      ];
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function uiowa_aggregator_preprocess_block__inline_block__uiowa_aggregator(&$variables) {
  /** @var \Drupal\Block\Entity\Block $block */
  $block = $variables['elements']['content']['#block_content'];

  if ($block->hasField('field_uiowa_headline')) {
    $headline_fields = $block->get('field_uiowa_headline')->getValue();
    foreach ($headline_fields as $headline_field) {
      // There isn't a headline, so set the children to this heading size.
      if (empty($headline_field['headline'])) {
        $heading_size = $headline_field['child_heading_size'];
      }
      else {
        $heading_size = HeadlineHelper::getHeadingSizeUp($headline_field['heading_size']);
      }
    }
  }

  $feeds = [];

  foreach ($block->get('field_uiowa_aggregator_feeds')->getIterator() as $list_string_item) {
    $feeds[] = $list_string_item->getString();
  }

  $per_page = (int) $block->get('field_uiowa_aggregator_count')->getString();
  $show_pager = (bool) $block->get('field_uiowa_aggregator_pager')->getString();

  $query = \Drupal::entityTypeManager()->getStorage('aggregator_item')->getQuery()
    ->condition('fid', $feeds, 'IN')
    ->sort('timestamp', 'DESC')
    ->sort('iid', 'DESC');

  if (!$show_pager) {
    $query->range(0, $per_page);
  }

  $result = $query->execute();

  $variables['content']['aggregator'] = [
    '#type' => 'container',
    '#attributes' => [
      'class' => [
        'aggregator-wrapper',
        'uiowa-aggregator',
        'list-container__inner',
      ],
    ],
  ];

  if ($result) {
    $variables['content']['aggregator']['feed_source'] = ['#markup' => ''];
    $items = \Drupal::entityTypeManager()->getStorage('aggregator_item')->loadMultiple($result);

    if ($items) {
      // If output is paged, overwrite $items with the current chunk.
      if ($show_pager) {
        $count = count($items);
        static $element = 0;
        $element++;
        /** @var \Drupal\Core\Pager\PagerManager $pager */
        $pager = \Drupal::service('pager.manager');
        $chunks = array_chunk($items, $per_page);
        $current = $pager->createPager($count, $per_page, $element)->getCurrentPage();
        $items = $chunks[$current];
      }

      // @todo Implement default card styles.
      $default_card_styles = [
        'headline_class' => 'headline--serif',
        'card_media_position' => 'card--layout-left',
        'styles' => 'bg--white',
      ];

      $variables['content']['aggregator']['items'] = \Drupal::entityTypeManager()->getViewBuilder('aggregator_item')->viewMultiple($items, 'default');

      foreach (Element::children($variables['content']['aggregator']['items']) as $id) {
        $variables['content']['aggregator']['items'][$id]['#override_styles'] = [
          ...$default_card_styles,
          ...$variables['elements']['#override_styles'],
        ];
      }

      if ($show_pager) {
        $variables['content']['pager'] = [
          '#type' => 'pager',
          '#element' => $element,
          '#quantity' => 3,
        ];
      }
    }
  }
  else {
    $variables['content']['no_results'] = [
      '#markup' => $block->get('field_uiowa_aggregator_text')->first()->value,
      '#prefix' => '<div class="uiowa-aggregator-no-results">',
      '#suffix' => '</div>',
    ];
  }

  // Unset classes meant for children.
  if (isset($variables['attributes']['class'])) {
    foreach ($variables['attributes']['class'] as $key => $style) {
      foreach ([
        'bg',
        'card',
        'media',
        'hide',
      ] as $check) {
        if (str_starts_with($style, $check)) {
          unset($variables['attributes']['class'][$key]);
        }
      }
    }
  }

  $variables['#attached']['feed'][] = [
    'aggregator/rss',
    \Drupal::configFactory()->get('system.site')->get('name') . ' ' . t('aggregator'),
  ];
}

/**
 * Allowed values callback for uiowa_aggregator_feeds field.
 */
function _uiowa_aggregator_get_feeds() {
  $feeds = \Drupal::entityTypeManager()->getStorage('aggregator_feed')->loadMultiple();
  $options = [];

  foreach ($feeds as $feed) {
    $options[$feed->id()] = $feed->label();
  }

  return $options;
}
